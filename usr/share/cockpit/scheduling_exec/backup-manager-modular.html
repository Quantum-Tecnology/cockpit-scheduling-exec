<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Gerenciador de Backups</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- PatternFly 4 CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/@patternfly/patternfly@4.224.5/patternfly.min.css"
      crossorigin="anonymous"
    />

    <!-- Branding do Cockpit -->
    <link rel="stylesheet" href="../../static/branding.css" />

    <!-- CSS Modular -->
    <link rel="stylesheet" href="css/backup-manager.css" />

    <!-- Cockpit JS API -->
    <script src="../base1/cockpit.js"></script>

    <!-- Template Loader -->
    <script src="js/template-loader.js"></script>

    <!-- M√≥dulos JavaScript (sem defer - fun√ß√µes exportadas imediatamente para onclick) -->
    <script src="js/utils.js"></script>
    <script src="js/directory-browser.js"></script>
    <script src="js/email.js"></script>
    <script src="js/backups.js"></script>
    <script src="js/vm-backup.js"></script>
    <script src="js/automation.js"></script>
    <script src="js/automation-actions.js"></script>
    <script src="js/automation-scripts.js"></script>
    <script src="js/schedules.js"></script>

    <!-- Core do Backup Manager -->
    <script src="backup-manager.js"></script>
  </head>

  <body>
    <div class="pf-c-page">
      <!-- Header -->
      <header class="pf-c-page__header">
        <div class="pf-c-page__header-brand">
          <div class="pf-c-page__header-brand-toggle"></div>
          <a class="pf-c-page__header-brand-link">
            <div class="pf-c-brand">
              <h1 style="margin: 0; color: white; font-size: 1.5rem">
                üóÑÔ∏è Gerenciador de Backups
              </h1>
            </div>
          </a>
        </div>
      </header>

      <!-- Main content -->
      <main style="width: 100%">
        <div
          class="pf-l-grid pf-m-gutter"
          style="padding: var(--pf-global--spacer--md); width: 100%"
        >
          <div class="pf-l-grid__item pf-m-12-col">
            <div id="status-message"></div>
          </div>

          <!-- Alertas -->
          <div class="pf-l-grid__item pf-m-12-col" id="alerts-container"></div>

          <!-- Tabs -->
          <div class="pf-l-grid__item pf-m-12-col">
            <div class="pf-c-tabs" id="backup-tabs">
              <ul class="pf-c-tabs__list">
                <li class="pf-c-tabs__item pf-m-current">
                  <button
                    class="pf-c-tabs__link"
                    id="tab-backups"
                    onclick="switchTab('backups')"
                  >
                    <span class="pf-c-tabs__item-text"
                      >üì¶ Lista de Backups</span
                    >
                  </button>
                </li>
                <li class="pf-c-tabs__item">
                  <button
                    class="pf-c-tabs__link"
                    id="tab-vms"
                    onclick="switchTab('vms')"
                  >
                    <span class="pf-c-tabs__item-text">üíø Backup de VMs</span>
                  </button>
                </li>
                <li class="pf-c-tabs__item">
                  <button
                    class="pf-c-tabs__link"
                    id="tab-automation"
                    onclick="switchTab('automation')"
                  >
                    <span class="pf-c-tabs__item-text">‚ö° Automa√ß√£o</span>
                  </button>
                </li>
                <li class="pf-c-tabs__item">
                  <button
                    class="pf-c-tabs__link"
                    id="tab-schedules"
                    onclick="switchTab('schedules')"
                  >
                    <span class="pf-c-tabs__item-text">üìÖ Agendamentos</span>
                  </button>
                </li>
                <li class="pf-c-tabs__item">
                  <button
                    class="pf-c-tabs__link"
                    id="tab-config"
                    onclick="switchTab('config')"
                  >
                    <span class="pf-c-tabs__item-text">‚öôÔ∏è Configura√ß√µes</span>
                  </button>
                </li>
              </ul>
            </div>
          </div>

          <!-- Container para templates das abas -->
          <div class="pf-l-grid__item pf-m-12-col">
            <!-- Bot√£o para toggle do log -->
            <button
              id="log-toggle-btn"
              class="pf-c-button pf-m-secondary log-toggle-btn"
              onclick="toggleGlobalLog()"
              title="Mostrar/Ocultar Log"
            >
              üìã
            </button>

            <!-- Layout de 2 colunas: Conte√∫do Principal + Log Global -->
            <div class="two-column-layout">
              <!-- Coluna Principal: Conte√∫do das Tabs -->
              <div class="main-content-column">
                <div id="tab-content-container">
                  <!-- Templates das abas s√£o carregados dinamicamente aqui -->
                </div>
              </div>

              <!-- Redimensionador -->
              <div class="resize-handle" id="resize-handle"></div>

              <!-- Coluna do Log Global -->
              <div class="log-column" id="log-column">
                <div class="global-log-container">
                  <div class="global-log-header">
                    <h3>üìã Log de Atividades</h3>
                    <div class="global-log-actions">
                      <button
                        class="pf-c-button pf-m-plain"
                        onclick="clearGlobalLog()"
                        title="Limpar Log"
                      >
                        üóëÔ∏è
                      </button>
                      <button
                        class="pf-c-button pf-m-plain"
                        onclick="downloadGlobalLog()"
                        title="Baixar Log"
                      >
                        üíæ
                      </button>
                      <button
                        class="pf-c-button pf-m-plain"
                        onclick="toggleGlobalLog()"
                        title="Ocultar Log"
                      >
                        ‚úï
                      </button>
                    </div>
                  </div>
                  <div class="global-log-body" id="global-log-body">
                    <div class="log-entry info">
                      [${new Date().toLocaleTimeString()}] Sistema iniciado
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Container para modais -->
    <div id="modals-container">
      <!-- Modais s√£o carregados dinamicamente aqui -->
    </div>

    <!-- Footer -->
    <div id="plugin-footer" class="plugin-footer">
      v1.5.0 ‚Äî Luis Gustavo Santarosa Pinto
    </div>

    <script>
      // Inicializa√ß√£o: carrega templates ao iniciar
      document.addEventListener("DOMContentLoaded", async () => {
        console.log(
          "DOMContentLoaded - Iniciando carregamento de templates..."
        );

        // Carregar templates das abas
        console.log("Carregando templates de abas...");
        await TemplateLoader.loadMultiple([
          {
            name: "tab-backups",
            target: "#tab-content-container",
            position: "append",
          },
          {
            name: "tab-config",
            target: "#tab-content-container",
            position: "append",
          },
          {
            name: "tab-vms",
            target: "#tab-content-container",
            position: "append",
          },
          {
            name: "tab-automation",
            target: "#tab-content-container",
            position: "append",
          },
          {
            name: "tab-schedules",
            target: "#tab-content-container",
            position: "append",
          },
        ]);

        console.log("Templates de abas carregados!");
        console.log("Verificando elementos:", {
          backups: !!document.getElementById("backups-tab-content"),
          config: !!document.getElementById("config-tab-content"),
          vms: !!document.getElementById("vms-tab-content"),
          automation: !!document.getElementById("automation-tab-content"),
          schedules: !!document.getElementById("schedules-tab-content"),
        });

        // Carregar modais
        console.log("Carregando modais...");
        await TemplateLoader.loadMultiple([
          {
            name: "modals/modal-add-directory",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-add-script-directory",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-confirm-delete",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-email",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-directory-browser",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-cron",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-script",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-env",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-script-env",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-log",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-sudo",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-import",
            target: "#modals-container",
            position: "append",
          },
          {
            name: "modals/modal-schedule",
            target: "#modals-container",
            position: "append",
          },
        ]);

        console.log("Modais carregados!");

        // Aguardar um momento para garantir que tudo foi renderizado
        await new Promise((resolve) => setTimeout(resolve, 100));

        // Verificar disponibilidade de fun√ß√µes
        console.log("Verificando fun√ß√µes dispon√≠veis:", {
          switchTab: typeof window.switchTab,
          init: typeof window.init,
        });

        // Exibir aba inicial (backups)
        console.log("Chamando window.switchTab('backups')...");
        if (typeof window.switchTab === "function") {
          window.switchTab("backups");
        } else {
          console.error(
            "window.switchTab n√£o est√° definida! Tipo:",
            typeof window.switchTab
          );
        }

        // Inicializar a aplica√ß√£o ap√≥s carregar templates
        if (typeof window.init === "function") {
          console.log("Chamando init()...");
          window.init();
        } else {
          console.log("Fun√ß√£o init() n√£o encontrada - OK, pode n√£o existir");
        }

        console.log("‚úÖ Inicializa√ß√£o completa!");
      });
    </script>
  </body>
</html>
